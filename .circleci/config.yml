version: 2.1

commands:
  check-build:
    parameters:
      rust-version:
        defaults: "1.59.0"
        type: string
    steps:
      - run rustup update <<parameters.rust-version>>
      - run cargo +<<parameters.rust-version>> check --all-features

jobs:
  build:
    docker:
      - image: cimg/rust:1.59

    steps:
      - checkout
      - run: cargo --version

      - run:
          name: Check Formatting
          command: |
            rustfmt --version
            cargo fmt --all -- --check

      - check-build
          rust-version: "nightly"

      - check-build
          rust-version: "stable"

      - check-build
          rust-version: "1.56.0"

  test:
    docker:
      - image: cimg/rust:1.59

    steps:
      - checkout
      - run:
          name: Test
          command: "cargo test --all-features"

      - run:
          name: Clippy
          command: "cargo clippy --all --tests --all-features -- -D warnings"

  docs:
    docker:
      - image: cimg/rust:1.59

    environment:
      RUSTDOCFLAGS: --cfg docsrs -Dwarnings

    steps:
      - checkout
      - run:
          name: Docs
          command: |
            rustup update nightly
            cargo +nightly doc --lib --no-deps --all-features --document-private-items
# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  build-test-docs:
    jobs:
      - build
      - test
      - docs
