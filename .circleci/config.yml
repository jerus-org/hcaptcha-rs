version: 2.1

setup: true

parameters:
  min-rust-version:
    type: string
    default: "1.75"
  fingerprint:
    type: string
    default: SHA256:OkxsH8Z6Iim6WDJBaII9eTT9aaO1f3eDc6IpsgYYPVg

orbs:
  toolkit: jerus-org/circleci-toolkit@0.6.0
  cont: circleci/continuation@1.0.0

executors:
  rust-env:
    docker:
      - image: jerusdp/ci-rust:<<pipeline.parameters.min-rust-version>>

jobs:
  check-for-bot:
    executor: rust-env
    parameters:
      bot-name:
        type: string
        default: "Jerus Bot"
        description: The name of the bot to check for
      continue_to:
        type: string
        default: ".circleci/validation.yml"
        description: The job to continue to if the bot is found
    steps:
      - checkout
      - run:
          name: Check if last commit made by bot
          command: |
            committer=$(git log -1 HEAD --pretty=format:%cn)
            echo $committer
            next_config=".circleci/validate.yml"
            if [[ "$committer" == "<< parameters.bot-name >>" ]]; then
              next_config=".circleci/success.yml"
            fi
            echo $next_config

            echo $"export CONTINUE_TO='$next_config'" >> $BASH_ENV
      - cont/continue:
          configuration_path: $CONTINUE_TO

workflows:
  bot-check:
    when:
      not:
        equal: [scheduled_pipeline, << pipeline.trigger_source >>]
    jobs:
      - check-for-bot:
          context: bot-check

  release:
    when:
      and:
        - equal: [scheduled_pipeline, << pipeline.trigger_source >>]
        - equal: ["release check", << pipeline.schedule.name >>]
    jobs:
      - toolkit/make_release:
          context:
            - release
          ssh_fingerprint: << pipeline.parameters.fingerprint >>
