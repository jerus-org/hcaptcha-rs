# SPDX-FileCopyrightText: 2022 jerusdp
#
# SPDX-License-Identifier: MIT OR Apache-2.0

version: 2.1

orbs:
  toolkit: jerus-org/circleci-toolkit@3.0.2

jobs:

  miri_tests:
    docker:
      - image: cimg/rust:1.83
    steps:
      - checkout
      - run: rustup toolchain install nightly --profile minimal
      - run: rustup +nightly component add miri
      - run: |
          set -eux
          # Allow std time/syscalls while still catching UB in Rust code
          export MIRIFLAGS="-Zmiri-disable-isolation"
          # Limit to core crate to keep runtime bounded
          cargo +nightly miri test -p hcaptcha --lib -- \
            --skip hcaptcha_mock_verify \
            --skip hcaptcha_mock_verify_request_reuse \
            --skip hcaptcha_mock_verify_not_found \
            --skip hcaptcha_mock_verify_client_response \
            --skip hcaptcha_mock_verify_client_response_not_found \
            --skip hcaptcha_mock_with_remoteip \
            --skip hcaptcha_mock_with_sitekey

  fuzz_smoke:
    docker:
      - image: cimg/rust:1.83
    steps:
      - checkout
      - run: rustup toolchain install nightly --profile minimal
      - run: cargo +nightly install cargo-fuzz
      - run: |
          set -eux
          # Short fuzz smoke (60s) on the response parser target
          cargo +nightly fuzz run response_parse -runs=0 -max_total_time=60 || true

workflows:
  audit:
    jobs:
      - toolkit/security:
          sonarcloud: false
      - miri_tests
      - fuzz_smoke
