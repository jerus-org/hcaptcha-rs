# SPDX-FileCopyrightText: 2022 jerusdp
#
# SPDX-License-Identifier: MIT OR Apache-2.0

version: 2.1

orbs:
  toolkit: jerus-org/circleci-toolkit@4.4.2

parameters:
  min_rust_version:
    type: string
    default: "1.88"
  docker-tag-suffix:
    type: string
    default: "-wasi"
  fingerprint:
    type: string
    default: SHA256:OkxsH8Z6Iim6WDJBaII9eTT9aaO1f3eDc6IpsgYYPVg
  pcu_verbosity:
    type: string
    default: "-vv"
    description: "Verbosity for pcu application executions."

executors:
  rust_env:
    docker:
      - image: jerusdp/ci-rust:<<pipeline.parameters.min_rust_version>><< pipeline.parameters.docker-tag-suffix >>
  base-env:
    docker:
      - image: jerusdp/ci-rust:base@sha256:236b32b508970fcea0a8963ac5493e1ab131e1503485ac06687259a0b66bba28

jobs:
  compute_checksums_and_upload:
    executor: rust_env
    steps:
      - checkout
      - run: cargo +stable --version
      - run:
          name: Set reproducible-build environment
          command: |
            echo "export SOURCE_DATE_EPOCH=$(git log -1 --pretty=%ct)" >> "$BASH_ENV"
            echo 'export CARGO_HOME=${CARGO_HOME:-/root/.cargo}' >> "$BASH_ENV"
            echo 'export RUSTFLAGS="--remap-path-prefix=$PWD=/src --remap-path-prefix=$CARGO_HOME=/cargo ${RUSTFLAGS:-}"' >> "$BASH_ENV"
            echo 'export CFLAGS="-g -O2 -fdebug-prefix-map=$PWD=/src -fmacro-prefix-map=$PWD=/src ${CFLAGS:-}"' >> "$BASH_ENV"
            echo 'export CARGO_PROFILE_RELEASE_DEBUG=true' >> "$BASH_ENV"
            source "$BASH_ENV"
      - run:
          name: Package crates
          command: |
            set -euxo pipefail
            mkdir -p dist
            for pkg in hcaptcha hcaptcha-cli; do
              if [ -f "${pkg}/Cargo.toml" ]; then
                cargo +stable package -p ${pkg} -Z unstable-options --allow-dirty --no-verify --output dist/${pkg}.crate
              fi
            done
      - run:
          name: Compute checksums
          command: |
            set -euxo pipefail
            (cd dist && sha256sum *.crate > checksums-sha256.txt)
      - run:
          name: Ensure GitHub CLI
          command: |
            set -euxo pipefail
            if ! command -v gh >/dev/null 2>&1; then
              if command -v apt-get >/devnull 2>&1; then
                apt-get update
                apt-get install -y gh
              else
                echo "gh CLI not available and apt-get not found" >&2
                exit 1
              fi
            fi
      - run:
          name: Upload to GitHub release
          command: |
            set -euxo pipefail
            # Map GITHUB_TOKEN to GH_TOKEN for gh CLI compatibility if needed
            if [ -n "${GITHUB_TOKEN:-}" ] && [ -z "${GH_TOKEN:-}" ]; then
              echo 'export GH_TOKEN=${GITHUB_TOKEN}' >> "$BASH_ENV"; source "$BASH_ENV"
            fi
            tag=$(git describe --tags --abbrev=0)
            gh release upload "$tag" dist/* --clobber

workflows:
  github-release:
    jobs:
      - toolkit/make_release:
          name: github release for hcaptcha
          context:
            - release
            - bot-check
          ssh_fingerprint: << pipeline.parameters.fingerprint >>
          min_rust_version: << pipeline.parameters.min_rust_version >>
          when_cargo_release: false
          pcu_verbosity: << pipeline.parameters.pcu_verbosity >>
          package: hcaptcha
          remove_ssh_key: false
          when_update_pcu: true
      - compute_checksums_and_upload:
          context:
            - release
            - bot-check
          requires:
            - github release for hcaptcha
